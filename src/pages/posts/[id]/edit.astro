---
import Layout from "../../../layouts/Layout.astro";
import { supabase } from "../../../lib/supabase";

const { id } = Astro.params;

// 1. Auth Check
const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/login");
}

const { data: { session } } = await supabase.auth.setSession({
  access_token: accessToken.value,
  refresh_token: refreshToken.value,
});

// 2. Handle Update Logic
if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const title = formData.get("title")?.toString();
    const content = formData.get("content")?.toString();
    const excerpt = formData.get("excerpt")?.toString();

    await supabase
        .from("posts")
        .update({ title, content, excerpt })
        .eq("id", id)
        .eq("user_id", session?.user.id); // Security: Ensure user owns post

    return Astro.redirect("/dashboard");
}

// 3. Fetch current post data to fill the form
const { data: post, error } = await supabase
    .from("posts")
    .select("*")
    .eq("id", id)
    .single();

if (error || !post) {
    return Astro.redirect("/dashboard");
}

// 4. Security Check: Prevent editing other people's posts
if (post.user_id !== session?.user.id) {
    return Astro.redirect("/dashboard");
}
---

<Layout title={`Edit ${post.title}`}>
  <div class="max-w-2xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold">Edit Post</h1>
        <a href="/dashboard" class="text-gray-600 hover:text-gray-900">Cancel</a>
    </div>

    <form method="POST" enctype="multipart/form-data" class="flex flex-col gap-6 bg-white p-8 rounded-lg shadow-sm">
        <label class="flex flex-col gap-2">
            <span class="font-semibold text-gray-700">Title</span>
            <input type="text" name="title" value={post.title} class="border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" required />
        </label>

        <label class="flex flex-col gap-2">
            <span class="font-semibold text-gray-700">Excerpt</span>
            <textarea name="excerpt" rows="2" class="border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">{post.excerpt}</textarea>
        </label>

        <label class="flex flex-col gap-2">
            <span class="font-semibold text-gray-700">Content</span>
            <textarea name="content" rows="10" class="border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>{post.content}</textarea>
        </label>

        <button class="bg-blue-600 text-white py-3 rounded hover:bg-blue-700 font-bold text-lg">
            Update Post
        </button>
    </form>
  </div>
</Layout>